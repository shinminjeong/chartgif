{% load static %}
<html>
<head>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  <link rel="stylesheet" href="{% static 'css/style.css' %}" />
  <title>Chartgif</title>
</head>
<body>
  <div class="row">
    <div class="col-md-6">
      <div style="padding-bottom: 20px">
        <div style="float:left">
          Chartgif <br/>
          World Life Expectancy vs Income
        </div>
        <div style="float:right">
          <div class="custom-control custom-switch">
            <input type="checkbox" class="custom-control-input" id="switchTrace">
            <label class="custom-control-label" for="switchTrace">Draw Trace</label>
          </div>
          <div class="custom-control custom-switch">
            <input type="checkbox" class="custom-control-input" id="switchHull">
            <label class="custom-control-label" for="switchHull">Draw Hull</label>
          </div>
        </div>
        <div style="float:right">
          <div class="custom-control custom-switch-play">
            <label>
              <input type="checkbox" class="custom-control-input" id="switchPlay">
            <i id="play_icon" class="fa fa-play"></i></label>
          </div>
        </div>
      </div>
      <div id="myChart"></div>
      <div class="year-background">
        <span id='infoCurYear'>
      </div>
    </div>
    <div class="col-md-6">
      <div id="clusterinfo" class="row"></div>
    </div>
  </div>
  <div class="row">
    <div class="col-md-12">
      <div class="timeline-background" id="timeline-background"></div>
      <div class="timeline-slider">
        <input type="range" class="slider" name="mySlider" id=mySlider min="1800" max="2018" value="1800"></input>
        <output for="foo" onforminput="value = foo.valueAsNumber;"></output>
      </div>
      <div class="timeline-frame" id="timeline"></div>
    </div>
  </div>
</body>

<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://d3js.org/d3-contour.v1.min.js"></script>
<script src="{% static 'js/scatter.js' %}"></script>
<script src="{% static 'js/trace.js' %}"></script>
<script src="{% static 'js/line.js' %}"></script>
<script src="{% static 'js/timeline.js' %}"></script>
<script>
var morecolor = d3.scaleOrdinal(d3.schemeCategory10);
var colorarray = ["#F08391", "#FCEC71", "#AEED6C", "#80DBEB"];
let gcolor = function(i){
  if (i < colorarray.length) {
    return colorarray[i];
  } else {
    return morecolor(i-colorarray.length);
  }
};

var data_plot = {{data|safe}};
var data_population = {{population|safe}};
var data_continent = {{continent|safe}};
var data_group = {{kgroup|safe}};
var cluster_info = {{clusterinfo|safe}};
var data_avg_velocity = {{avg_velocity|safe}};
var data_focus_range = {{focus_range|safe}};

var w = document.getElementById("myChart").offsetWidth,
    h = w*0.7;
var label_w = Math.min(200, Math.max(120, w*0.2));
var left_offset = 66;
var chart = new ScatterPlot("myChart", w, h);
chart.initChart(data_plot, data_population, data_continent, data_group);

var timeline_w = document.getElementById("timeline-background").offsetWidth;
var timeline_h = 300;
var timeline = new TimeLine("timeline", timeline_w, timeline_h);
timeline.initChart([1800, 2018]);

var el, newPoint;
var linecharts_v = {};
var gname = ["Asia", "Europe", "America", "Africa"];
var infodiv = document.getElementById("clusterinfo");
function kFormatter(num) {
    if (Math.abs(num) > 999999)
      return Math.sign(num)*((Math.abs(num)/1000000).toFixed(1)) + 'M'
    if (Math.abs(num) > 999)
      return Math.sign(num)*((Math.abs(num)/1000).toFixed(1)) + 'K'
    return Math.sign(num)*Math.abs(num)
}

function initClusterinfo() {
  // var div_year = document.createElement("div");
  // div_year.innerHTML="Year = <span id='infoCurYear'>" + curYear + "</span><br>";
  // div_year.classList.add("col-md-12");
  // infodiv.appendChild(div_year);

  var numGroup = cluster_info["K"];
  var minmax = cluster_info["minmax"];
  var group_h = h/numGroup+5;
  for (var g = 0; g < numGroup; g++) {
    var div_group = document.createElement("div");
    div_group.style = "display:block; padding: 10px; height: "+group_h+"px;";

    var div_group_label = document.createElement("div");
    div_group_label.style = "display:inline-block; vertical-align:top; width:"+label_w+"px; height: "+group_h+"px;";
    div_group_label.innerHTML += "<input type='checkbox' class='switchLegend' id='"+gname[g]+"' checked>";
    div_group_label.innerHTML += "<span class='badge' style='width:85%;background-color:"+gcolor(g)+"'>" + gname[g] + "</span><br>";
    div_group_label.innerHTML += "<div class='group_label'><span id='infoMinMax_"+g+"'></span></div>"
    div_group_label.innerHTML += "<div class='group_trace' id='trace_chart_" + g + "'></div>"

    var div_group_timeline = document.createElement("div");
    div_group_timeline.style="display:inline-block; position: relative; padding:0; width:"+(w-label_w)+"px; height: "+group_h+"px;";

    var div_group_timeline_avg_v = document.createElement("div");
    var div_group_timeline_avg_a = document.createElement("div");
    div_group_timeline_avg_v.id = "lines_v_"+gname[g];
    div_group_timeline_avg_a.id = div_group_timeline_avg_v.id+"_overlay";
    div_group_timeline_avg_v.style = "width:"+(w-label_w)+"px; height: "+group_h+"px; position: absolute; top:10; z-index:0";
    div_group_timeline_avg_a.style = "width:"+(w-label_w)+"px; height: "+group_h+"px; position: absolute; top:10; left: "+left_offset+"; z-index:1";
    div_group_timeline.appendChild(div_group_timeline_avg_a);
    div_group_timeline.appendChild(div_group_timeline_avg_v);

    div_group.appendChild(div_group_label);
    div_group.appendChild(div_group_timeline);
    infodiv.appendChild(div_group);

    linecharts_v[g] = new LineChart(div_group_timeline_avg_v.id, w-label_w, group_h, left_offset);
    linecharts_v[g].drawChart(data_avg_velocity[g]);
  }
  drawTraceCharts(numGroup);
}

function updateClusterinfo(year) {
  var info_year = document.getElementById("infoCurYear");
  info_year.innerHTML = year;

  var numGroup = cluster_info["K"];
  var minmax = cluster_info["minmax"];
  for (var g = 0; g < numGroup; g++) {
    var info_minmax = document.getElementById("infoMinMax_"+g);
    info_minmax.innerHTML = "";
    for (var a in minmax[g][year]) {
      info_minmax.innerHTML += a + ": " + kFormatter(minmax[g][year][a]["min"]) + "~" + kFormatter(minmax[g][year][a]["max"]) + "<br>";
    }
  }
}

function drawTraceCharts(numGroup) {
  var trace_chart = {};
  for (var g = 0; g < numGroup; g++) {
    trace_chart[g] = new TraceChart("trace_chart_", g);
    trace_chart[g].draw(data_plot, data_population, data_continent, data_group);
  }
}

var timeslices = {};
var yearmap = {};
var outerbound = {};
function initTimeFrame() {
  for (var y = 1800; y <= 2019; y++) {
    yearmap[y] = [];
  }
  for (var g in data_focus_range) {
    for (var a in data_focus_range[g]) {
      // console.log(gname[g], a, data_focus_range[g][a])
      for (var r in data_focus_range[g][a]) {
        range = data_focus_range[g][a][r]
        if (range.length  <= 1) continue;
        drawFrame(range, g, a);
        draw_rect_input(range, "lines_v_"+gname[g]);
      }
    }
  }
}

function drawFrame(yrange, group, axis) {
  // console.log("drawFrame", yrange, group, axis)
  // axis: X, Y, S or (overlay == input from the linecharts)
  r = [yrange[0], yrange[yrange.length-1]];
  for (var i = r[0]; i <= r[1]; i++) {
    // console.log("addFrame", i, group)
    yearmap[i].push(+group)
    if (!timeslices[i]) {
      timeslices[i] = {};
    }
    timeslices[i] = {"g":[+group], "until":r[1]};
  }
  timeline.addFrame(r, +group);
  calculateOuterbound();
}

initClusterinfo();
initTimeFrame();

var curYear = 1800;
var maxYear = 2018;
var play_timer = undefined;
var flagConvexHulls = false;
var playon = document.querySelectorAll("input#switchPlay");
playon[0].addEventListener("change", function(e) {
  // console.log("playon", e.target.checked, curYear);
  if (e.target.checked) {
    document.getElementById("play_icon").className = "fa fa-pause";
  } else {
    document.getElementById("play_icon").className = "fa fa-play";
  }

  var timing = 100;
  if (play_timer == undefined && e.target.checked && curYear < maxYear) {
    play_timer = setInterval(function() {
      curYear += 1;
      if (curYear >= maxYear) {
        clearInterval(play_timer);
      }
      // console.log("original", timing, curYear, maxYear);
      traceTimeline();
    }, timing);
  } else if (play_timer != undefined) {
    clearInterval(play_timer);
    play_timer = undefined;
  }
});

function resetPlaytimer(timing) {
  curYear -= 1;
  clearInterval(play_timer);
  play_timer = setInterval(function() {
    curYear += 1;
    if (curYear >= maxYear) {
      clearInterval(play_timer);
      play_timer = undefined;
    }
    // console.log("after reset", timing, curYear, maxYear);
    traceTimeline();
  }, timing);
}

function calculateOuterbound() {
  outerbound = {};
  timeline.clearOuterBound();
  var head_y = -1, tail_y = -1;
  var groups = [];
  for (var y in yearmap) {
    if (yearmap[y].length > 0) {
      // console.log("-", y, head_y, tail_y)
      groups = groups.concat(yearmap[y]);
      if (head_y > 0) {
        tail_y = y;
      } else {
        head_y = tail_y = y;
      }
    } else {
      if (head_y > 0) {
        // console.log("add", head_y, tail_y)
        outerbound[+head_y+1] = {
          "head": +head_y+1,
          "tail": +tail_y+1,
          "groups": new Set(groups)
        }
        timeline.addOuterBound([head_y, tail_y]);
      }
      head_y = tail_y = -1;
      groups = [];
    }
  }
}

function changeSelectedConts(continents) {
  swtvalues["trace"] = false;
  swtvalues["hull"] = false;
  swtvalues["groups"][0] = false;
  swtvalues["groups"][1] = false;
  swtvalues["groups"][2] = false;
  swtvalues["groups"][3] = false;
  for (var c = 0; c < continents.length; c++) {
    swtvalues["groups"][continents[c]] = true;
  }
}

var flag_focus = false;
var focus_index = -1,
    focus_start = focus_until = -1,
    focus_groups = [];
function traceTimeline() {
  console.log("traceTimeline", curYear, outerbound[curYear], flag_focus, focus_until);
  var groups = [];
  if (!flag_focus && outerbound[curYear]) {
    console.log("start focusing")
    flag_focus = true;
    focus_start = outerbound[curYear]["head"]-1;
    focus_until = outerbound[curYear]["tail"];
    focus_groups = Array.from(outerbound[curYear]["groups"]);
    console.log("focus_index == ", focus_index)
    if (focus_index == -1) {
      changeSelectedConts([0,1,2,3]);
      resetPlaytimer(1000);
    } else {
      console.log("focus_groups == ", focus_groups, focus_groups[focus_index])
      changeSelectedConts([focus_groups[focus_index]]);
      resetPlaytimer(1000);
    }
  } else if (flag_focus && curYear == focus_until) {
    console.log("finish focusing", focus_index, focus_groups)
    if (focus_index >= focus_groups.length-1) {
      focus_index = -1;
      changeSelectedConts([0,1,2,3]);
      resetPlaytimer(100); // go to the normal pace
    } else {
      focus_index += 1;
      curYear = focus_start;
    }
    flag_focus = false;
    chart.clearFocus();
  } else {
    console.log(curYear, flag_focus);
    changeSlider($("input[type='range']"), curYear, true, flag_focus);
  }
}


var legendCount = 4;
var swtvalues = {
  "trace": false,
  "hull": false,
  "groups": {0: true, 1:true, 2:true, 3:true},
};
var traceon = document.querySelectorAll("input#switchTrace");
traceon[0].addEventListener("change", function(e) {
  console.log("traceon", e.target.checked);
  swtvalues["trace"] = e.target.checked;
  chart.updateChart(curYear, swtvalues);
});

var hullon = document.querySelectorAll("input#switchHull");
hullon[0].addEventListener("change", function(e) {
  console.log("hullon", e.target.checked);
  swtvalues["hull"] = e.target.checked;
  chart.updateChart(curYear, swtvalues);
});

var switchLegends = document.querySelectorAll("input.switchLegend");
for (var s = 0; s < legendCount; s++) {
  switchLegends[s].addEventListener("change", function(e) {
    console.log("switchLegends", this.id, e.target.checked);
    swtvalues["groups"][gname.indexOf(this.id)] = e.target.checked;
    chart.updateChart(curYear, swtvalues);
  });
}


$('input[type=range]').on('input', function () {
  $(this).trigger('change');
});
$("input[type='range']").change(function() {
  el = $(this);
  curYear  = parseInt(el.val());
  changeSlider(el, curYear, false, false);
})
// Fake a change to position bubble at page load
.trigger('change');

function changeSlider(el, curYear, play, focus) {
  width = el.width();
  newPoint = (curYear-el.attr("min")) / (el.attr("max")-el.attr("min")+1);
  // console.log(newPoint, el.val())
  el.next("output")
    .css({
      "marginLeft": width * newPoint-19,
      "height": 20,
    })
    .text(curYear);
  if (play) {
    el.val(curYear);
  }
  if (focus) {
    chart.updateFocus(curYear, swtvalues);
  } else {
    chart.updateChart(curYear, swtvalues);
  }
  updateClusterinfo(curYear);
}

</script>
</html>
